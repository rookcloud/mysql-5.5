#!/bin/bash
set -e

if [[ $ROOK_DEVELOPMENT_MODE = true ]]; then
  new_uid=$(stat -c %u /rook/config)
else
  new_uid=1234
fi

if [[ -e /rook/persist/db ]]; then
  echo "Updating old MySQL files to new UID"
  find /rook/persist/db -user $(id -u mysql) -print0 | xargs -0 chown $new_uid
fi

echo "Setting new MySQL UID"
usermod -u $new_uid mysql

mkdir -p /var/run/mysqld
chown mysql:mysql /var/run/mysqld
